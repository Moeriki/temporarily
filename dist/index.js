'use strict';

Object.defineProperty(exports, "__esModule", {
  value: true
});
exports.cleanup = cleanup;
exports.dir = dir;
exports.file = file;
exports.filepath = filepath;

var _fs = require('fs');

var _fs2 = _interopRequireDefault(_fs);

var _os = require('os');

var _os2 = _interopRequireDefault(_os);

var _path = require('path');

var _path2 = _interopRequireDefault(_path);

function _interopRequireDefault(obj) { return obj && obj.__esModule ? obj : { default: obj }; }

// constants

var EMPTY_STRING = '';

var DEFAULT_DIR_MODE = 0o777;
var DEFAULT_ENCODING = 'utf8';
var DEFAULT_FILE_MODE = 0o666;
var DEFAULT_NAME = 'temporarily-{WWWWDDDD}';

var DIGIT = '1234567890';
var WORD = 'abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ';

var OS_TMP_DIR = _os2.default.tmpdir();

var TEMPLATE_INTERPOLATE = /\{([^}]+)\}/g;

// private

var random = function random(chars) {
  return chars[Math.round(Math.random() * chars.length)];
};

var templateChars = {
  /* eslint-disable id-length */
  d: DIGIT,
  w: WORD
  /* eslint-enable id-length */
};

var templateReplacer = function templateReplacer(match, innerMatch) {
  return innerMatch.split(EMPTY_STRING).map(function (char) {
    var chars = templateChars[char.toLowerCase()];
    if (!chars) {
      throw new Error(`Expected template placeholder to be one of: ${Object.keys(templateChars).join(', ')}. Received ${char}`);
    }
    return random(chars);
  }).join(EMPTY_STRING);
};

var tempDirs = [];
var tempFiles = [];

// auto clean up

process.on('exit', cleanup);

// exports

function cleanup() {
  tempFiles.forEach(function (tempFile) {
    _fs2.default.unlinkSync(tempFile.filepath);
  });
  tempFiles.length = 0;
  tempDirs.forEach(function (tempDir) {
    _fs2.default.rmdirSync(tempDir.filepath);
  });
  tempDirs.length = 0;
}

function dir() {
  var options = arguments.length > 0 && arguments[0] !== undefined ? arguments[0] : {};
  var files = options.files,
      _options$mode = options.mode,
      mode = _options$mode === undefined ? DEFAULT_DIR_MODE : _options$mode;

  var tempDir = {
    filepath: filepath(options),
    mode
  };
  try {
    _fs2.default.accessSync(tempDir.filepath, _fs2.default.F_OK);
  } catch (err) {
    if (err.code !== 'ENOENT') {
      throw new Error(`Could not check ${tempDir.filepath}.`);
    }
    tempDirs.push(tempDir);
    var parentDir = _path2.default.dirname(tempDir.filepath);
    dir({
      dir: _path2.default.dirname(parentDir),
      name: _path2.default.basename(parentDir)
    });
    _fs2.default.mkdirSync(tempDir.filepath, mode);
  }
  if (files) {
    var dirFileOptions = { dir: tempDir.filepath };
    tempDir.files = files.map(function (dirFile) {
      return file(Object.assign({}, dirFileOptions, dirFile));
    });
  }
  return tempDir;
}

function file() {
  var options = arguments.length > 0 && arguments[0] !== undefined ? arguments[0] : {};
  var _options$data = options.data,
      data = _options$data === undefined ? '' : _options$data,
      _options$encoding = options.encoding,
      encoding = _options$encoding === undefined ? DEFAULT_ENCODING : _options$encoding,
      _options$mode2 = options.mode,
      mode = _options$mode2 === undefined ? DEFAULT_FILE_MODE : _options$mode2;

  var tempFile = {
    data,
    filepath: filepath(options),
    mode
  };
  var parentDir = _path2.default.dirname(tempFile.filepath);
  try {
    _fs2.default.accessSync(parentDir, _fs2.default.F_OK);
  } catch (err) {
    if (err.code !== 'ENOENT') {
      throw new Error(`Could not check ${parentDir}.`);
    }
    dir({
      dir: _path2.default.dirname(parentDir),
      name: _path2.default.basename(parentDir)
    });
  }
  _fs2.default.writeFileSync(tempFile.filepath, data, { encoding, mode });
  tempFiles.push(tempFile);
  return tempFile;
}

function filepath() {
  var _ref = arguments.length > 0 && arguments[0] !== undefined ? arguments[0] : {},
      _ref$dir = _ref.dir,
      dirPath = _ref$dir === undefined ? OS_TMP_DIR : _ref$dir,
      _ref$ext = _ref.ext,
      ext = _ref$ext === undefined ? null : _ref$ext,
      _ref$name = _ref.name,
      name = _ref$name === undefined ? DEFAULT_NAME : _ref$name;

  var dirname = _path2.default.resolve(dirPath);
  var basename = name.replace(TEMPLATE_INTERPOLATE, templateReplacer);
  return _path2.default.join(dirname, `${basename}${ext ? `.${ext}` : ''}`);
}
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uL2xpYi9pbmRleC5qcyJdLCJuYW1lcyI6WyJjbGVhbnVwIiwiZGlyIiwiZmlsZSIsImZpbGVwYXRoIiwiRU1QVFlfU1RSSU5HIiwiREVGQVVMVF9ESVJfTU9ERSIsIkRFRkFVTFRfRU5DT0RJTkciLCJERUZBVUxUX0ZJTEVfTU9ERSIsIkRFRkFVTFRfTkFNRSIsIkRJR0lUIiwiV09SRCIsIk9TX1RNUF9ESVIiLCJ0bXBkaXIiLCJURU1QTEFURV9JTlRFUlBPTEFURSIsInJhbmRvbSIsImNoYXJzIiwiTWF0aCIsInJvdW5kIiwibGVuZ3RoIiwidGVtcGxhdGVDaGFycyIsImQiLCJ3IiwidGVtcGxhdGVSZXBsYWNlciIsIm1hdGNoIiwiaW5uZXJNYXRjaCIsInNwbGl0IiwibWFwIiwiY2hhciIsInRvTG93ZXJDYXNlIiwiRXJyb3IiLCJPYmplY3QiLCJrZXlzIiwiam9pbiIsInRlbXBEaXJzIiwidGVtcEZpbGVzIiwicHJvY2VzcyIsIm9uIiwiZm9yRWFjaCIsInRlbXBGaWxlIiwidW5saW5rU3luYyIsInRlbXBEaXIiLCJybWRpclN5bmMiLCJvcHRpb25zIiwiZmlsZXMiLCJtb2RlIiwiYWNjZXNzU3luYyIsIkZfT0siLCJlcnIiLCJjb2RlIiwicHVzaCIsInBhcmVudERpciIsImRpcm5hbWUiLCJuYW1lIiwiYmFzZW5hbWUiLCJta2RpclN5bmMiLCJkaXJGaWxlT3B0aW9ucyIsImRpckZpbGUiLCJhc3NpZ24iLCJkYXRhIiwiZW5jb2RpbmciLCJ3cml0ZUZpbGVTeW5jIiwiZGlyUGF0aCIsImV4dCIsInJlc29sdmUiLCJyZXBsYWNlIl0sIm1hcHBpbmdzIjoiOzs7OztRQW9EZ0JBLE8sR0FBQUEsTztRQVdBQyxHLEdBQUFBLEc7UUFnQ0FDLEksR0FBQUEsSTtRQTRCQUMsUSxHQUFBQSxROztBQTNIaEI7Ozs7QUFDQTs7OztBQUNBOzs7Ozs7QUFFQTs7QUFFQSxJQUFNQyxlQUFlLEVBQXJCOztBQUVBLElBQU1DLG1CQUFtQixLQUF6QjtBQUNBLElBQU1D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ZUFBR1UsYUFBSCxDQUFpQnRCLFNBQVNuQyxRQUExQixFQUFvQ3VELElBQXBDLEVBQTBDLEVBQUVDLFFBQUYsRUFBWWYsSUFBWixFQUExQztBQUNBVixZQUFVZSxJQUFWLENBQWVYLFFBQWY7QUFDQSxTQUFPQSxRQUFQO0FBQ0Q7O0FBRU0sU0FBU25DLFFBQVQsR0FJQztBQUFBLGlGQUFKLEVBQUk7QUFBQSxzQkFITkYsR0FHTTtBQUFBLE1BSEQ0RCxPQUdDLDRCQUhTbEQsVUFHVDtBQUFBLHNCQUZObUQsR0FFTTtBQUFBLE1BRk5BLEdBRU0sNEJBRkEsSUFFQTtBQUFBLHVCQUROVixJQUNNO0FBQUEsTUFETkEsSUFDTSw2QkFEQzVDLFlBQ0Q7O0FBQ04sTUFBTTJDLFVBQVUsZUFBS1ksT0FBTCxDQUFhRixPQUFiLENBQWhCO0FBQ0EsTUFBTVIsV0FBV0QsS0FBS1ksT0FBTCxDQUFhbkQsb0JBQWIsRUFBbUNTLGdCQUFuQyxDQUFqQjtBQUNBLFNBQU8sZUFBS1UsSUFBTCxDQUFVbUIsT0FBVixFQUFvQixHQUFFRSxRQUFTLEdBQUVTLE1BQU8sSUFBR0EsR0FBSSxFQUFkLEdBQWtCLEVBQUcsRUFBdEQsQ0FBUDtBQUNEIiwiZmlsZSI6ImluZGV4LmpzIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IGZzIGZyb20gJ2ZzJztcbmltcG9ydCBvcyBmcm9tICdvcyc7XG5pbXBvcnQgcGF0aCBmcm9tICdwYXRoJztcblxuLy8gY29uc3RhbnRzXG5cbmNvbnN0IEVNUFRZX1NUUklORyA9ICcnO1xuXG5jb25zdCBERUZBVUxUX0RJUl9NT0RFID0gMG83Nzc7XG5jb25zdCBERUZBVUxUX0VOQ09ESU5HID0gJ3V0ZjgnO1xuY29uc3QgREVGQVVMVF9GSUxFX01PREUgPSAwbzY2NjtcbmNvbnN0IERFRkFVTFRfTkFNRSA9ICd0ZW1wb3JhcmlseS17V1dXV0RERER9JztcblxuY29uc3QgRElHSVQgPSAnMTIzNDU2Nzg5MCc7XG5jb25zdCBXT1JEID0gJ2FiY2RlZmdoaWprbG1ub3BxcnN0dXZ3eHl6QUJDREVGR0hJSktMTU5PUFFSU1RVVldYWVonO1xuXG5jb25zdCBPU19UTVBfRElSID0gb3MudG1wZGlyKCk7XG5cbmNvbnN0IFRFTVBMQVRFX0lOVEVSUE9MQVRFID0gL1xceyhbXn1dKylcXH0vZztcblxuLy8gcHJpdmF0ZVxuXG5jb25zdCByYW5kb20gPSAoY2hhcnMpID0+IGNoYXJzW01hdGgucm91bmQoTWF0aC5yYW5kb20oKSAqIGNoYXJzLmxlbmd0aCldO1xuXG5jb25zdCB0ZW1wbGF0ZUNoYXJzID0ge1xuICAvKiBlc2xpbnQtZGlzYWJsZSBpZC1sZW5ndGggKi9cbiAgZDogRElHSVQsXG4gIHc6IFdPUkQsXG4gIC8qIGVzbGludC1lbmFibGUgaWQtbGVuZ3RoICovXG59O1xuXG5jb25zdCB0ZW1wbGF0ZVJlcGxhY2VyID0gKG1hdGNoLCBpbm5lck1hdGNoKSA9PiBpbm5lck1hdGNoXG4gIC5zcGxpdChFTVBUWV9TVFJJTkcpXG4gIC5tYXAoKGNoYXIpID0+IHtcbiAgICBjb25zdCBjaGFycyA9IHRlbXBsYXRlQ2hhcnNbY2hhci50b0xvd2VyQ2FzZSgpXTtcbiAgICBpZiAoIWNoYXJzKSB7XG4gICAgICB0aHJvdyBuZXcgRXJyb3IoYEV4cGVjdGVkIHRlbXBsYXRlIHBsYWNlaG9sZGVyIHRvIGJlIG9uZSBvZjogJHtPYmplY3Qua2V5cyh0ZW1wbGF0ZUNoYXJzKS5qb2luKCcsICcpfS4gUmVjZWl2ZWQgJHtjaGFyfWApO1xuICAgIH1cbiAgICByZXR1cm4gcmFuZG9tKGNoYXJzKTtcbiAgfSlcbiAgLmpvaW4oRU1QVFlfU1RSSU5HKVxuO1xuXG5jb25zdCB0ZW1wRGlycyA9IFtdO1xuY29uc3QgdGVtcEZpbGVzID0gW107XG5cbi8vIGF1dG8gY2xlYW4gdXBcblxucHJvY2Vzcy5vbignZXhpdCcsIGNsZWFudXApO1xuXG4vLyBleHBvcnRzXG5cbmV4cG9ydCBmdW5jdGlvbiBjbGVhbnVwKCkge1xuICB0ZW1wRmlsZXMuZm9yRWFjaCgodGVtcEZpbGUpID0+IHtcbiAgICBmcy51bmxpbmtTeW5jKHRlbXBGaWxlLmZpbGVwYXRoKTtcbiAgfSk7XG4gIHRlbXBGaWxlcy5sZW5ndGggPSAwO1xuICB0ZW1wRGlycy5mb3JFYWNoKCh0ZW1wRGlyKSA9PiB7XG4gICAgZnMucm1kaXJTeW5jKHRlbXBEaXIuZmlsZXBhdGgpO1xuICB9KTtcbiAgdGVtcERpcnMubGVuZ3RoID0gMDtcbn1cblxuZXhwb3J0IGZ1bmN0aW9uIGRpcihvcHRpb25zID0ge30pIHtcbiAgY29uc3Qge1xuICAgIGZpbGVzLFxuICAgIG1vZGUgPSBERUZBVUxUX0RJUl9NT0RFLFxuICB9ID0gb3B0aW9ucztcbiAgY29uc3QgdGVtcERpciA9IHtcbiAgICBmaWxlcGF0aDogZmlsZXBhdGgob3B0aW9ucyksXG4gICAgbW9kZSxcbiAgfTtcbiAgdHJ5IHtcbiAgICBmcy5hY2Nlc3NTeW5jKHRlbXBEaXIuZmlsZXBhdGgsIGZzLkZfT0spO1xuICB9IGNhdGNoIChlcnIpIHtcbiAgICBpZiAoZXJyLmNvZGUgIT09ICdFTk9FTlQnKSB7XG4gICAgICB0aHJvdyBuZXcgRXJyb3IoYENvdWxkIG5vdCBjaGVjayAke3RlbXBEaXIuZmlsZXBhdGh9LmApO1xuICAgIH1cbiAgICB0ZW1wRGlycy5wdXNoKHRlbXBEaXIpO1xuICAgIGNvbnN0IHBhcmVudERpciA9IHBhdGguZGlybmFtZSh0ZW1wRGlyLmZpbGVwYXRoKTtcbiAgICBkaXIoe1xuICAgICAgZGlyOiBwYXRoLmRpcm5hbWUocGFyZW50RGlyKSxcbiAgICAgIG5hbWU6IHBhdGguYmFzZW5hbWUocGFyZW50RGlyKSxcbiAgICB9KTtcbiAgICBmcy5ta2RpclN5bmModGVtcERpci5maWxlcGF0aCwgbW9kZSk7XG4gIH1cbiAgaWYgKGZpbGVzKSB7XG4gICAgY29uc3QgZGlyRmlsZU9wdGlvbnMgPSB7IGRpcjogdGVtcERpci5maWxlcGF0aCB9O1xuICAgIHRlbXBEaXIuZmlsZXMgPSBmaWxlcy5tYXAoKGRpckZpbGUpID0+XG4gICAgICBmaWxlKE9iamVjdC5hc3NpZ24oe30sIGRpckZpbGVPcHRpb25zLCBkaXJGaWxlKSlcbiAgICApO1xuICB9XG4gIHJldHVybiB0ZW1wRGlyO1xufVxuXG5leHBvcnQgZnVuY3Rpb24gZmlsZShvcHRpb25zID0ge30pIHtcbiAgY29uc3Qge1xuICAgIGRhdGEgPSAnJyxcbiAgICBlbmNvZGluZyA9IERFRkFVTFRfRU5DT0RJTkcsXG4gICAgbW9kZSA9IERFRkFVTFRfRklMRV9NT0RFLFxuICB9ID0gb3B0aW9ucztcbiAgY29uc3QgdGVtcEZpbGUgPSB7XG4gICAgZGF0YSxcbiAgICBmaWxlcGF0aDogZmlsZXBhdGgob3B0aW9ucyksXG4gICAgbW9kZSxcbiAgfTtcbiAgY29uc3QgcGFyZW50RGlyID0gcGF0aC5kaXJuYW1lKHRlbXBGaWxlLmZpbGVwYXRoKTtcbiAgdHJ5IHtcbiAgICBmcy5hY2Nlc3NTeW5jKHBhcmVudERpciwgZnMuRl9PSyk7XG4gIH0gY2F0Y2ggKGVycikge1xuICAgIGlmIChlcnIuY29kZSAhPT0gJ0VOT0VOVCcpIHtcbiAgICAgIHRocm93IG5ldyBFcnJvcihgQ291bGQgbm90IGNoZWNrICR7cGFyZW50RGlyfS5gKTtcbiAgICB9XG4gICAgZGlyKHtcbiAgICAgIGRpcjogcGF0aC5kaXJuYW1lKHBhcmVudERpciksXG4gICAgICBuYW1lOiBwYXRoLmJhc2VuYW1lKHBhcmVudERpciksXG4gICAgfSk7XG4gIH1cbiAgZnMud3JpdGVGaWxlU3luYyh0ZW1wRmlsZS5maWxlcGF0aCwgZGF0YSwgeyBlbmNvZGluZywgbW9kZSB9KTtcbiAgdGVtcEZpbGVzLnB1c2godGVtcEZpbGUpO1xuICByZXR1cm4gdGVtcEZpbGU7XG59XG5cbmV4cG9ydCBmdW5jdGlvbiBmaWxlcGF0aCh7XG4gIGRpcjogZGlyUGF0aCA9IE9TX1RNUF9ESVIsXG4gIGV4dCA9IG51bGwsXG4gIG5hbWUgPSBERUZBVUxUX05BTUUsXG59ID0ge30pIHtcbiAgY29uc3QgZGlybmFtZSA9IHBhdGgucmVzb2x2ZShkaXJQYXRoKTtcbiAgY29uc3QgYmFzZW5hbWUgPSBuYW1lLnJlcGxhY2UoVEVNUExBVEVfSU5URVJQT0xBVEUsIHRlbXBsYXRlUmVwbGFjZXIpO1xuICByZXR1cm4gcGF0aC5qb2luKGRpcm5hbWUsIGAke2Jhc2VuYW1lfSR7ZXh0ID8gYC4ke2V4dH1gIDogJyd9YCk7XG59XG4iXX0=